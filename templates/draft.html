<!DOCTYPE html>
<html>
<head>
  <title>Snake Draft - Week {{ current_week }}</title>
  <style>
    @keyframes flash-bg { 0%{background:#fff;}20%{background:#ffe680;}40%{background:#fff;}60%{background:#ffe680;}80%{background:#fff;}100%{background:#fff;} }
    .flash { animation: flash-bg 0.8s ease-in-out 1; }
    table { border-collapse: collapse; }
    th, td { border:1px solid #999; padding:6px; }
    th { background:#f4f4f4; }
  </style>
  <script>
    const USERNAME = {{ username|tojson }};
    let lastOnTheClock = null;

    function playBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.4, ctx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.35);
        o.start(); o.stop(ctx.currentTime + 0.36);
      } catch(e) {}
    }
    function flashScreen(){ document.body.classList.add('flash'); setTimeout(()=>document.body.classList.remove('flash'), 800); }

    function buildRunningTallyByUser(data) {
      // Header: Player | Round 1 | Round 2 | ...
      const rounds = data.rounds_total;
      const order = data.order;
      const thead = document.getElementById('tallyHead');
      thead.innerHTML = '<tr><th>Player</th>' + Array.from({length: rounds}, (_,i)=>`<th>Round ${i+1}</th>`).join('') + '</tr>';

      // Body: one row per player in base draft order; cells = that user's pick in that round
      const tbody = document.getElementById('tallyBody');
      tbody.innerHTML = '';
      for (const user of order) {
        let tr = document.createElement('tr');
        let cells = `<td><strong>${user}</strong></td>`;
        for (let r=1; r<=rounds; r++) {
          const val = (data.grid[user] && data.grid[user][r]) ? data.grid[user][r] : '';
          cells += `<td>${val}</td>`;
        }
        tr.innerHTML = cells;
        tbody.appendChild(tr);
      }
    }

    async function refreshUI() {
      const week = {{ current_week }};
      try {
        const res = await fetch('/draft_state?week=' + week, {cache: 'no-store'});
        if (!res.ok) return;
        const data = await res.json();

        const otcEl = document.getElementById('onTheClock');
        if (otcEl) otcEl.textContent = data.on_the_clock || '';

        const draftComplete = (data.status === 'complete');
        if (!draftComplete && data.on_the_clock !== lastOnTheClock) {
          if (data.on_the_clock === USERNAME) { playBeep(); flashScreen(); }
          lastOnTheClock = data.on_the_clock;
        }

        // Build the new by-user tally
        buildRunningTallyByUser(data);

        // Auto-refresh driver dropdown
        const select = document.querySelector('select[name="driver"]');
        if (select) {
          const current = select.value;
          const newOptions = data.available || [];
          const existing = Array.from(select.options).map(o => o.value);
          const changed = existing.length !== newOptions.length || existing.some((v,i) => v !== newOptions[i]);
          if (changed) {
            select.innerHTML = '';
            for (const d of newOptions) {
              const opt = document.createElement('option');
              opt.value = d; opt.textContent = d;
              select.appendChild(opt);
            }
            if (newOptions.includes(current)) { select.value = current; }
          }
        }
      } catch(e) {}
    }

    setInterval(refreshUI, 3000);
    window.addEventListener('load', refreshUI);
  </script>
</head>
<body>
{% if draft.status != "complete" %}
  <h2>Snake Draft — Week {{ current_week }}{% if sched %} — {{ sched.race_name }}{% if sched.race_date %} ({{ sched.race_date }}){% endif %}{% endif %} — Round {{ draft.current_round }}</h2>
{% else %}
  <h2>{% if sched %}{{ sched.race_name }}{% if sched.race_date %} ({{ sched.race_date }}){% endif %}{% else %}Draft Complete{% endif %}</h2>
{% endif %}

<p>Status: <strong>{{ draft.status }}</strong></p>
<p><strong>Draft order (this week):</strong> {{ draft.order|join(", ") }}</p>
<p><strong>On the clock:</strong> <span id="onTheClock">{{ on_the_clock }}</span></p>

<form method="get" action="/draft" style="margin:12px 0;">
  <label for="week">Jump to week:</label>
  <select id="week" name="week">
    {% for s in schedule_list %}
      <option value="{{ s.week }}" {% if s.week == current_week %}selected{% endif %}>
        Week {{ s.week }} — {{ s.race_name }}{% if s.race_date %} ({{ s.race_date }}){% endif %}
      </option>
    {% endfor %}
  </select>
  <button type="submit">Go</button>
</form>

<div style="margin: 12px 0;">
  <a href="/all_picks" style="padding:8px 12px;border:1px solid #444;border-radius:6px;text-decoration:none;">View All Picks</a>
  <a href="/schedule" style="padding:8px 12px;border:1px solid #444;border-radius:6px;text-decoration:none;margin-left:8px;">View Schedule</a>
  {% if session.is_admin %}
    | <a href="/admin_order">Set Draft Order</a>
    | <a href="/admin_reset_picks">Reset picks</a>
    | <a href="/admin_schedule">Manage Schedule</a>
    | <a href="/admin_users">Manage Users</a>
  {% endif %}
  | <a href="/logout">Log out</a>
</div>

<h3>Your picks so far</h3>
{% if my_picks %}
  <ol>{% for r, d in my_picks %}<li>Round {{ r }} — {{ d }}</li>{% endfor %}</ol>
{% else %}<p>(none yet)</p>{% endif %}

{% if draft.status != "complete" %}
  {% if is_my_turn %}
    <h3>Make your pick</h3>
    <form method="post">
      <label>Choose a driver:</label>
      <select name="driver">
        {% for d in available %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
      </select>
      <span style="margin:0 8px;">or</span>
      <input type="text" name="custom_driver" placeholder="Type a driver not in list">
      <button type="submit">Draft</button>
    </form>
  {% else %}
    <p>Waiting for <strong>{{ on_the_clock }}</strong> to pick...</p>
  {% endif %}
{% else %}
  <h3>Draft complete!</h3>
  <p>View results on <a href="/all_picks?week={{ current_week }}">All Picks</a>.</p>
{% endif %}

<h3 style="margin-top:20px;">Running Tally (Players x Rounds)</h3>
<table>
  <thead id="tallyHead"></thead>
  <tbody id="tallyBody"></tbody>
</table>

</body>
</html>
